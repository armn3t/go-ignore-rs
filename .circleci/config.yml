# ──────────────────────────────────────────────────────────────────────────────
# go-ignore-rs CI pipeline
# ──────────────────────────────────────────────────────────────────────────────
# Runs every pre-commit check, plus more, on every push / PR.
#
# Jobs:
#   rust-checks  – fmt ▸ clippy ▸ unit tests ▸ WASM release build
#   go-checks    – fmt ▸ vet ▸ golangci-lint ▸ tests (race detector)
#
# The Go job depends on rust-checks so it always tests against a freshly-built
# WASM binary rather than the one committed to the repo.
# ──────────────────────────────────────────────────────────────────────────────
version: 2.1

# ── Parameters ────────────────────────────────────────────────────────────────
# Change these if you bump your toolchain versions.
parameters:
  rust-version:
    type: string
    default: "1.93"
  go-version:
    type: string
    default: "1.25"
  wasm-target:
    type: string
    default: "wasm32-wasip1"

# ── Jobs ──────────────────────────────────────────────────────────────────────
jobs:
  # ╭──────────────────────────────────────────────────────╮
  # │ Rust: format, lint, test, build WASM                 │
  # ╰──────────────────────────────────────────────────────╯
  rust-checks:
    docker:
      - image: cimg/rust:<< pipeline.parameters.rust-version >>
    resource_class: medium
    environment:
      CARGO_TERM_COLOR: always
    steps:
      - checkout

      # ── Cache: Cargo registry + git db ──
      - restore_cache:
          keys:
            - cargo-registry-v1-{{ checksum "rust-wasm/Cargo.lock" }}
            - cargo-registry-v1-

      # ── Install WASM target ──
      - run:
          name: Add wasm32-wasip1 target
          command: rustup target add << pipeline.parameters.wasm-target >>

      # ── Format check ──
      - run:
          name: Check Rust formatting
          command: cargo fmt -- --check
          working_directory: rust-wasm

      # ── Clippy ──
      - run:
          name: Run Clippy (deny warnings)
          command: cargo clippy --target << pipeline.parameters.wasm-target >> -- -D warnings
          working_directory: rust-wasm

      # ── Unit tests (native, not WASM) ──
      - run:
          name: Run Rust tests
          command: cargo test
          working_directory: rust-wasm

      # ── Build WASM release binary ──
      - run:
          name: Build WASM (release)
          command: cargo build --target << pipeline.parameters.wasm-target >> --release
          working_directory: rust-wasm

      # ── Copy WASM to project root (same layout as justfile) ──
      - run:
          name: Copy matcher.wasm to project root
          command: cp rust-wasm/target/<< pipeline.parameters.wasm-target >>/release/matcher.wasm .

      # ── Save caches ──
      - save_cache:
          key: cargo-registry-v1-{{ checksum "rust-wasm/Cargo.lock" }}
          paths:
            - ~/.cargo/registry
            - ~/.cargo/git
            - rust-wasm/target

      # ── Persist the freshly-built WASM for downstream jobs ──
      - persist_to_workspace:
          root: .
          paths:
            - matcher.wasm

  # ╭──────────────────────────────────────────────────────╮
  # │ Go: format, vet, lint, test                          │
  # ╰──────────────────────────────────────────────────────╯
  go-checks:
    docker:
      - image: cimg/go:<< pipeline.parameters.go-version >>
    resource_class: medium
    environment:
      GOFLAGS: ""
      GOTOOLCHAIN: auto
    steps:
      - checkout

      # ── Attach the freshly-built WASM from rust-checks ──
      - attach_workspace:
          at: .

      # ── Cache: Go modules ──
      - restore_cache:
          keys:
            - go-mod-v1-{{ checksum "go.sum" }}
            - go-mod-v1-

      - run:
          name: Download Go modules
          command: go mod download

      - save_cache:
          key: go-mod-v1-{{ checksum "go.sum" }}
          paths:
            - ~/go/pkg/mod

      # ── Format check ──
      - run:
          name: Check Go formatting
          command: |
            unformatted=$(gofmt -l .)
            if [ -n "$unformatted" ]; then
              echo "The following files need formatting:"
              echo "$unformatted"
              exit 1
            fi
            echo "All Go files are properly formatted."

      # ── go vet ──
      - run:
          name: Run go vet
          command: go vet ./...

      # ── golangci-lint ──
      - run:
          name: Install golangci-lint
          command: |
            curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh \
              | sh -s -- -b "$(go env GOPATH)/bin"
            golangci-lint --version

      - run:
          name: Run golangci-lint
          command: golangci-lint run ./...

      # ── Install gotestsum for JUnit output ──
      - run:
          name: Install gotestsum
          command: go install gotest.tools/gotestsum@latest

      # ── Tests with race detector + JUnit XML for CircleCI insights ──
      - run:
          name: Run Go tests
          command: |
            mkdir -p /tmp/test-results
            gotestsum \
              --format standard-verbose \
              --junitfile /tmp/test-results/go-tests.xml \
              -- -race -count=1 ./...

      - store_test_results:
          path: /tmp/test-results

# ── Workflows ─────────────────────────────────────────────────────────────────
workflows:
  ci:
    jobs:
      - rust-checks
      - go-checks:
          requires:
            - rust-checks